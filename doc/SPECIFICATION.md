# BLE Orchestrator æŠ€è¡“ä»•æ§˜æ›¸

ãƒãƒ¼ã‚¸ãƒ§ãƒ³: 0.1.0  
æœ€çµ‚æ›´æ–°: 2025-10-24

---

## ğŸ“‹ ç›®æ¬¡

1. [æ¦‚è¦](#æ¦‚è¦)
2. [ã‚·ã‚¹ãƒ†ãƒ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£](#ã‚·ã‚¹ãƒ†ãƒ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£)
3. [ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆä»•æ§˜](#ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆä»•æ§˜)
4. [APIä»•æ§˜](#apiä»•æ§˜)
5. [ãƒ‡ãƒ¼ã‚¿å‹å®šç¾©](#ãƒ‡ãƒ¼ã‚¿å‹å®šç¾©)
6. [é€šä¿¡ãƒ—ãƒ­ãƒˆã‚³ãƒ«](#é€šä¿¡ãƒ—ãƒ­ãƒˆã‚³ãƒ«)
7. [è¨­å®šé …ç›®](#è¨­å®šé …ç›®)
8. [ã‚¨ãƒ©ãƒ¼å‡¦ç†](#ã‚¨ãƒ©ãƒ¼å‡¦ç†)
9. [æ’ä»–åˆ¶å¾¡ãƒ¡ã‚«ãƒ‹ã‚ºãƒ ](#æ’ä»–åˆ¶å¾¡ãƒ¡ã‚«ãƒ‹ã‚ºãƒ )
10. [ãƒ­ã‚°ä»•æ§˜](#ãƒ­ã‚°ä»•æ§˜)

---

## æ¦‚è¦

### ã‚·ã‚¹ãƒ†ãƒ ã®ç›®çš„

BLE Orchestratorã¯ã€è¤‡æ•°ã®Pythonã‚¹ã‚¯ãƒªãƒ—ãƒˆã‹ã‚‰å®‰å…¨ã«BLEï¼ˆBluetooth Low Energyï¼‰ãƒ‡ãƒã‚¤ã‚¹ã‚’æ“ä½œã™ã‚‹ãŸã‚ã®å¸¸é§å‹ã‚µãƒ¼ãƒ“ã‚¹ã§ã™ã€‚

### ä¸»è¦æ©Ÿèƒ½

1. **BLEãƒ‡ãƒã‚¤ã‚¹ã®é›†ç´„åˆ¶å¾¡**
   - è¤‡æ•°ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‹ã‚‰ã®BLEæ“ä½œã‚’é›†ç´„
   - ãƒ‡ãƒã‚¤ã‚¹ã‚¹ã‚­ãƒ£ãƒ³ã¨ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç®¡ç†
   - æ¥ç¶šå‡¦ç†ã®ä¸€å…ƒåŒ–

2. **ã‚¹ã‚­ãƒ£ãƒ³ã‚­ãƒ£ãƒƒã‚·ãƒ¥**
   - BLEãƒ‡ãƒã‚¤ã‚¹ã®ã‚¢ãƒ‰ãƒã‚¿ã‚¤ã‚ºãƒ¡ãƒ³ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’5åˆ†é–“ã‚­ãƒ£ãƒƒã‚·ãƒ¥
   - æ¥ç¶šä¸è¦ã§ãƒ‡ãƒã‚¤ã‚¹æƒ…å ±ã‚’é«˜é€Ÿå–å¾—

3. **å„ªå…ˆåº¦ä»˜ããƒªã‚¯ã‚¨ã‚¹ãƒˆã‚­ãƒ¥ãƒ¼**
   - HIGH/NORMAL/LOWã®3æ®µéšå„ªå…ˆåº¦
   - ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆç›£è¦–
   - å¤ã„ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®è‡ªå‹•ã‚¹ã‚­ãƒƒãƒ—

4. **è‡ªå‹•å¾©æ—§æ©Ÿèƒ½**
   - BLEæ¥ç¶šå¤±æ•—æ™‚ã®è‡ªå‹•ãƒªãƒˆãƒ©ã‚¤
   - ã‚¢ãƒ€ãƒ—ã‚¿ãƒªã‚»ãƒƒãƒˆ
   - Bluetoothã‚µãƒ¼ãƒ“ã‚¹å†èµ·å‹•

5. **æ’ä»–åˆ¶å¾¡**
   - ã‚¹ã‚­ãƒ£ãƒŠãƒ¼ã¨ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆæ¥ç¶šã®ç«¶åˆå›é¿
   - BlueZãƒ¬ãƒ™ãƒ«ã§ã®ãƒªã‚½ãƒ¼ã‚¹ç®¡ç†

6. **é€šçŸ¥ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³**
   - BLE Notificationã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å—ä¿¡
   - è¤‡æ•°ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¸ã®é…ä¿¡

### æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯

- **è¨€èª**: Python 3.9ä»¥ä¸Š
- **BLEãƒ©ã‚¤ãƒ–ãƒ©ãƒª**: Bleak 0.21.1-0.22.x
- **éåŒæœŸå‡¦ç†**: asyncio
- **IPC**: Unix Domain Socket / TCP Socket
- **ãƒ‡ãƒ¼ã‚¿ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³**: JSON
- **ãƒ­ã‚°**: Python logging (RotatingFileHandler)
- **ãƒ—ãƒ­ã‚»ã‚¹ç®¡ç†**: systemd

---

## ã‚·ã‚¹ãƒ†ãƒ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

### å…¨ä½“æ§‹æˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Client Applications                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚ Sensor   â”‚  â”‚ Control  â”‚  â”‚ Monitor  â”‚             â”‚
â”‚  â”‚ Script   â”‚  â”‚ Script   â”‚  â”‚ Script   â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚             â”‚             â”‚
        â”‚   IPC (Unix Socket / TCP) â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  BLE Orchestrator Service                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚              IPC Server                            â”‚â”‚
â”‚  â”‚  - Request Handler                                 â”‚â”‚
â”‚  â”‚  - Notification Distributor                        â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚       â”‚                                       â”‚         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ Queue Managerâ”‚                   â”‚ Notification   â”‚â”‚
â”‚  â”‚              â”‚                   â”‚ Manager        â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚       â”‚                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚         Request Handler                            â”‚â”‚
â”‚  â”‚  - Read/Write/Scan Request Processing             â”‚â”‚
â”‚  â”‚  - BleakClient Management                          â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚       â”‚                                       â”‚         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ BLE Scanner  â”‚                   â”‚   Watchdog     â”‚â”‚
â”‚  â”‚ - Continuous â”‚                   â”‚ - Health Check â”‚â”‚
â”‚  â”‚   Scanning   â”‚                   â”‚ - Auto Recoveryâ”‚â”‚
â”‚  â”‚ - Cache Mgmt â”‚                   â”‚                â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â”‚ Bleak API
          â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         â”‚      Operating System (Linux)                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”                                       â”‚
â”‚  â”‚    BlueZ     â”‚  Bluetooth Stack                      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                                       â”‚
â”‚         â”‚                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”                                       â”‚
â”‚  â”‚ BLE Adapter  â”‚  Hardware (hci0, hci1)                â”‚
â”‚  â”‚   (HCI)      â”‚                                       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼

#### 1. ã‚¹ã‚­ãƒ£ãƒ³ãƒ‡ãƒ¼ã‚¿ã®æµã‚Œ

```
BLE Device â†’ Adapter â†’ BlueZ â†’ Bleak â†’ Scanner â†’ Cache â†’ Client
            (Advertisement)     (Callback)  (Store)   (Query)
```

#### 2. ã‚³ãƒãƒ³ãƒ‰é€ä¿¡ã®æµã‚Œ

```
Client â†’ IPC â†’ Queue â†’ Handler â†’ BleakClient â†’ Adapter â†’ BLE Device
       (Request) (Enqueue) (Process) (Connect)   (HCI)
```

#### 3. é€šçŸ¥ã®æµã‚Œ

```
BLE Device â†’ Adapter â†’ BleakClient â†’ Notification Manager â†’ IPC â†’ Client
           (Notify)    (Callback)     (Distribute)          (Push)
```

---

## ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆä»•æ§˜

### 1. BLEScanner

**ãƒ•ã‚¡ã‚¤ãƒ«**: `ble_orchestrator/orchestrator/scanner.py`

**è²¬å‹™**:
- BLEãƒ‡ãƒã‚¤ã‚¹ã®å¸¸æ™‚ã‚¹ã‚­ãƒ£ãƒ³
- ã‚¢ãƒ‰ãƒã‚¿ã‚¤ã‚ºãƒ¡ãƒ³ãƒˆãƒ‡ãƒ¼ã‚¿ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç®¡ç†
- ã‚¹ã‚­ãƒ£ãƒŠãƒ¼ã®è‡ªå‹•å†ä½œæˆ

**ä¸»è¦ãƒ¡ã‚½ãƒƒãƒ‰**:

```python
class BLEScanner:
    async def start() -> None
        """ã‚¹ã‚­ãƒ£ãƒ³ã‚’é–‹å§‹"""
    
    async def stop() -> None
        """ã‚¹ã‚­ãƒ£ãƒ³ã‚’åœæ­¢"""
    
    def request_scanner_stop() -> None
        """æ’ä»–åˆ¶å¾¡ç”¨: ã‚¹ã‚­ãƒ£ãƒŠãƒ¼åœæ­¢ã‚’è¦æ±‚"""
    
    def notify_client_completed() -> None
        """æ’ä»–åˆ¶å¾¡ç”¨: ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå‡¦ç†å®Œäº†ã‚’é€šçŸ¥"""
```

**ã‚¹ã‚­ãƒ£ãƒ³ã‚­ãƒ£ãƒƒã‚·ãƒ¥**:
- TTL: 300ç§’ï¼ˆ5åˆ†ï¼‰
- æœ€å¤§ãƒ‡ãƒã‚¤ã‚¹æ•°: åˆ¶é™ãªã—
- å„ãƒ‡ãƒã‚¤ã‚¹ã®å±¥æ­´: æœ€æ–°10ä»¶ã¾ã§

**è‡ªå‹•å†ä½œæˆæ¡ä»¶**:
- ãƒ‡ãƒã‚¤ã‚¹æœªæ¤œå‡ºãŒ90ç§’ä»¥ä¸Šç¶™ç¶š
- æœ€çµ‚ã‚¹ã‚­ãƒ£ãƒ³ã‹ã‚‰90ç§’ä»¥ä¸ŠçµŒé
- å†ä½œæˆé–“éš”: æœ€çŸ­180ç§’ï¼ˆ3åˆ†ï¼‰

### 2. BLERequestHandler

**ãƒ•ã‚¡ã‚¤ãƒ«**: `ble_orchestrator/orchestrator/handler.py`

**è²¬å‹™**:
- BLEãƒªã‚¯ã‚¨ã‚¹ãƒˆã®å‡¦ç†
- BleakClientã«ã‚ˆã‚‹ãƒ‡ãƒã‚¤ã‚¹æ¥ç¶š
- èª­ã¿å–ã‚Š/æ›¸ãè¾¼ã¿æ“ä½œ

**ä¸»è¦ãƒ¡ã‚½ãƒƒãƒ‰**:

```python
class BLERequestHandler:
    async def handle_request(request: BLERequest) -> None
        """ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å‡¦ç†"""
    
    async def _handle_scan_request(request: ScanRequest) -> None
        """ã‚¹ã‚­ãƒ£ãƒ³ãƒªã‚¯ã‚¨ã‚¹ãƒˆå‡¦ç†ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰å–å¾—ï¼‰"""
    
    async def _handle_read_request(request: ReadRequest) -> None
        """èª­ã¿å–ã‚Šãƒªã‚¯ã‚¨ã‚¹ãƒˆå‡¦ç†"""
    
    async def _handle_write_request(request: WriteRequest) -> None
        """æ›¸ãè¾¼ã¿ãƒªã‚¯ã‚¨ã‚¹ãƒˆå‡¦ç†"""
```

**æ¥ç¶šä»•æ§˜**:
- ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ: 10ç§’
- ãƒªãƒˆãƒ©ã‚¤å›æ•°: 2å›
- ãƒªãƒˆãƒ©ã‚¤é–“éš”: 1ç§’
- ä½¿ç”¨ã‚¢ãƒ€ãƒ—ã‚¿: hci1ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰

### 3. RequestQueueManager

**ãƒ•ã‚¡ã‚¤ãƒ«**: `ble_orchestrator/orchestrator/queue_manager.py`

**è²¬å‹™**:
- ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚­ãƒ¥ãƒ¼ã®ç®¡ç†
- å„ªå…ˆåº¦ä»˜ãå‡¦ç†
- ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆç›£è¦–

**ã‚­ãƒ¥ãƒ¼ä»•æ§˜**:

| ã‚­ãƒ¥ãƒ¼ç¨®åˆ¥ | å‡¦ç†æ–¹å¼ | ãƒ¯ãƒ¼ã‚«ãƒ¼æ•° | ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ |
|----------|---------|-----------|------------|
| ãƒ¡ã‚¤ãƒ³ã‚­ãƒ¥ãƒ¼ | é€æ¬¡å‡¦ç† | 1 | ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ¯ |
| ã‚¹ã‚­ãƒ£ãƒ³ã‚­ãƒ¥ãƒ¼ | ä¸¦è¡Œå‡¦ç† | 3 | 5ç§’ |

**å„ªå…ˆåº¦**:
```python
class RequestPriority(Enum):
    HIGH = 0      # æœ€å„ªå…ˆ
    NORMAL = 1    # é€šå¸¸
    LOW = 2       # ä½å„ªå…ˆåº¦
```

**å¤ã„ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ã‚¹ã‚­ãƒƒãƒ—**:
- æœ‰åŠ¹/ç„¡åŠ¹: `SKIP_OLD_REQUESTS` (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: True)
- æœ€å¤§å¾…æ©Ÿæ™‚é–“: 30ç§’
- ã‚¹ã‚­ãƒƒãƒ—å¾Œã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: FAILED

### 4. BLEWatchdog

**ãƒ•ã‚¡ã‚¤ãƒ«**: `ble_orchestrator/orchestrator/watchdog.py`

**è²¬å‹™**:
- BLEæ¥ç¶šå¤±æ•—ã®ç›£è¦–
- ã‚¢ãƒ€ãƒ—ã‚¿ã®è‡ªå‹•å¾©æ—§
- ã‚µãƒ¼ãƒ“ã‚¹å†èµ·å‹•

**ç›£è¦–é–“éš”**: 30ç§’

**å¾©æ—§ã‚·ãƒ¼ã‚±ãƒ³ã‚¹**:

1. **è»½é‡ãƒªã‚»ãƒƒãƒˆï¼ˆBleakClientå¤±æ•—æ™‚ï¼‰**
   ```bash
   sudo hciconfig hci0 down
   sudo hciconfig hci0 up
   ```

2. **é€šå¸¸ãƒªã‚»ãƒƒãƒˆï¼ˆé€£ç¶šå¤±æ•—3å›ä»¥ä¸Šï¼‰**
   ```bash
   sudo hciconfig hci0 reset
   ```

3. **é‡åº¦éšœå®³ï¼ˆãƒªã‚»ãƒƒãƒˆå¤±æ•—æ™‚ï¼‰**
   ```bash
   sudo systemctl restart bluetooth
   ```

### 5. IPCServer

**ãƒ•ã‚¡ã‚¤ãƒ«**: `ble_orchestrator/orchestrator/ipc_server.py`

**è²¬å‹™**:
- ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¨ã®é€šä¿¡
- ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®å—ä»˜
- é€šçŸ¥ã®é…ä¿¡

**é€šä¿¡æ–¹å¼**:
- Unix Domain Socket: `/tmp/ble-orchestrator.sock`ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰
- TCP Socket: `127.0.0.1:8378`ï¼ˆç’°å¢ƒå¤‰æ•°ã§åˆ‡æ›¿ï¼‰

**ãƒ—ãƒ­ãƒˆã‚³ãƒ«**: JSON over line-delimited text

**æœ€å¤§æ¥ç¶šæ•°**: 10

### 6. NotificationManager

**ãƒ•ã‚¡ã‚¤ãƒ«**: `ble_orchestrator/orchestrator/notification_manager.py`

**è²¬å‹™**:
- BLE Notificationã®ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ç®¡ç†
- è¤‡æ•°ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¸ã®é…ä¿¡
- æ¥ç¶šç®¡ç†

**ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ä»•æ§˜**:
- ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ: 0ï¼ˆç„¡é™ï¼‰ã¾ãŸã¯æŒ‡å®šç§’æ•°
- è‡ªå‹•å†æ¥ç¶š: ã‚ã‚Š
- æ’ä»–åˆ¶å¾¡: æœ‰åŠ¹

---

## APIä»•æ§˜

### ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆAPI

**ãƒ•ã‚¡ã‚¤ãƒ«**: `ble_orchestrator/client/client.py`

#### 1. scan_command

**èª¬æ˜**: ã‚¹ã‚­ãƒ£ãƒ³ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰ãƒ‡ãƒã‚¤ã‚¹æƒ…å ±ã‚’å–å¾—ï¼ˆæ¥ç¶šä¸è¦ï¼‰

**ãƒªã‚¯ã‚¨ã‚¹ãƒˆ**:
```json
{
  "command": "scan_command",
  "mac_address": "AA:BB:CC:DD:EE:FF",
  "service_uuid": "optional",
  "characteristic_uuid": "optional",
  "request_id": "uuid4-string"
}
```

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹**:
```json
{
  "status": "success",
  "request_id": "uuid4-string",
  "result": {
    "address": "AA:BB:CC:DD:EE:FF",
    "name": "Device Name",
    "rssi": -60,
    "advertisement_data": {...},
    "manufacturer_data": {...}
  }
}
```

**ç‰¹å¾´**:
- å³åº§ã«ãƒ¬ã‚¹ãƒãƒ³ã‚¹ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰å–å¾—ï¼‰
- æ¥ç¶šä¸è¦ã®ãŸã‚é«˜é€Ÿ
- ä¸¦è¡Œå‡¦ç†ï¼ˆ3ãƒ¯ãƒ¼ã‚«ãƒ¼ï¼‰

#### 2. read_command

**èª¬æ˜**: ãƒ‡ãƒã‚¤ã‚¹ã«æ¥ç¶šã—ã¦Characteristicã®å€¤ã‚’èª­ã¿å–ã‚‹

**ãƒªã‚¯ã‚¨ã‚¹ãƒˆ**:
```json
{
  "command": "read_command",
  "mac_address": "AA:BB:CC:DD:EE:FF",
  "service_uuid": "0000180f-0000-1000-8000-00805f9b34fb",
  "characteristic_uuid": "00002a19-0000-1000-8000-00805f9b34fb",
  "priority": "NORMAL",
  "timeout": 10.0,
  "request_id": "uuid4-string"
}
```

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹**:
```json
{
  "status": "success",
  "request_id": "uuid4-string",
  "result": {
    "data": [0x42, 0x4C, 0x45],
    "hex": "424c45"
  }
}
```

**ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ**: 10ç§’ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰

#### 3. send_command

**èª¬æ˜**: ãƒ‡ãƒã‚¤ã‚¹ã«æ¥ç¶šã—ã¦Characteristicã«å€¤ã‚’æ›¸ãè¾¼ã‚€

**ãƒªã‚¯ã‚¨ã‚¹ãƒˆ**:
```json
{
  "command": "send_command",
  "mac_address": "AA:BB:CC:DD:EE:FF",
  "service_uuid": "0000180f-0000-1000-8000-00805f9b34fb",
  "characteristic_uuid": "00002a19-0000-1000-8000-00805f9b34fb",
  "data": "0100",
  "response_required": false,
  "priority": "NORMAL",
  "timeout": 10.0,
  "request_id": "uuid4-string"
}
```

**ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ**:
- 16é€²æ•°æ–‡å­—åˆ—: "0100" â†’ bytes([0x01, 0x00])
- ãƒã‚¤ãƒˆé…åˆ—: [1, 0]
- byteså‹: b'\x01\x00'

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹**:
```json
{
  "status": "success",
  "request_id": "uuid4-string",
  "result": {
    "response_data": [0x01, 0x00]  // response_required=trueã®å ´åˆ
  }
}
```

#### 4. subscribe_notifications

**èª¬æ˜**: BLE Notificationã‚’è³¼èª­

**ãƒªã‚¯ã‚¨ã‚¹ãƒˆ**:
```json
{
  "command": "subscribe_notifications",
  "mac_address": "AA:BB:CC:DD:EE:FF",
  "service_uuid": "0000180f-0000-1000-8000-00805f9b34fb",
  "characteristic_uuid": "00002a19-0000-1000-8000-00805f9b34fb",
  "callback_id": "optional-callback-id",
  "notification_timeout": 0,
  "request_id": "uuid4-string"
}
```

**é€šçŸ¥ãƒ‡ãƒ¼ã‚¿**ï¼ˆãƒ—ãƒƒã‚·ãƒ¥ï¼‰:
```json
{
  "type": "notification",
  "callback_id": "callback-id",
  "mac_address": "AA:BB:CC:DD:EE:FF",
  "characteristic_uuid": "00002a19-0000-1000-8000-00805f9b34fb",
  "value": [0x42, 0x4C, 0x45],
  "timestamp": 1234567890.123
}
```

#### 5. unsubscribe_notifications

**èª¬æ˜**: BLE Notificationã®è³¼èª­ã‚’è§£é™¤

**ãƒªã‚¯ã‚¨ã‚¹ãƒˆ**:
```json
{
  "command": "unsubscribe_notifications",
  "callback_id": "callback-id",
  "request_id": "uuid4-string"
}
```

#### 6. get_service_status

**èª¬æ˜**: ã‚µãƒ¼ãƒ“ã‚¹ã®çŠ¶æ…‹ã‚’å–å¾—

**ãƒªã‚¯ã‚¨ã‚¹ãƒˆ**:
```json
{
  "command": "get_service_status",
  "request_id": "uuid4-string"
}
```

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹**:
```json
{
  "status": "success",
  "result": {
    "is_running": true,
    "adapter_status": "ok",
    "queue_size": 0,
    "uptime_sec": 3600.5,
    "active_devices": 5,
    "active_subscriptions": 2,
    "exclusive_control_enabled": true,
    "client_connecting": false,
    "log_status": {
      "total_files": 3,
      "total_size_mb": 25.6,
      "usage_percent": 42.7
    }
  }
}
```

---

## ãƒ‡ãƒ¼ã‚¿å‹å®šç¾©

**ãƒ•ã‚¡ã‚¤ãƒ«**: `ble_orchestrator/orchestrator/types.py`

### RequestPriority

```python
class RequestPriority(Enum):
    HIGH = 0
    NORMAL = 1
    LOW = 2
```

### RequestStatus

```python
class RequestStatus(Enum):
    PENDING = auto()       # ã‚­ãƒ¥ãƒ¼ã§å¾…æ©Ÿä¸­
    PROCESSING = auto()    # å‡¦ç†ä¸­
    COMPLETED = auto()     # å®Œäº†
    FAILED = auto()        # å¤±æ•—
    TIMEOUT = auto()       # ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
```

### ScanResult

```python
@dataclass
class ScanResult:
    address: str                              # MACã‚¢ãƒ‰ãƒ¬ã‚¹
    name: Optional[str] = None                # ãƒ‡ãƒã‚¤ã‚¹å
    rssi: Optional[int] = None                # ä¿¡å·å¼·åº¦
    advertisement_data: Dict[str, Any] = {}   # ã‚¢ãƒ‰ãƒã‚¿ã‚¤ã‚ºãƒ¡ãƒ³ãƒˆãƒ‡ãƒ¼ã‚¿
    timestamp: float = 0.0                    # å–å¾—æ™‚åˆ»ï¼ˆUNIXã‚¿ã‚¤ãƒ ï¼‰
```

### BLERequest

```python
@dataclass
class BLERequest:
    request_id: str                           # ãƒªã‚¯ã‚¨ã‚¹ãƒˆIDï¼ˆUUIDï¼‰
    mac_address: str                          # MACã‚¢ãƒ‰ãƒ¬ã‚¹
    priority: RequestPriority = NORMAL        # å„ªå…ˆåº¦
    timeout_sec: float = 10.0                 # ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
    status: RequestStatus = PENDING           # ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
    error_message: Optional[str] = None       # ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
    response_data: Any = None                 # ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒ‡ãƒ¼ã‚¿
    created_at: float = time.time()           # ä½œæˆæ™‚åˆ»
```

### ReadRequest

```python
@dataclass
class ReadRequest(BLERequest):
    service_uuid: str = ""                    # Service UUID
    characteristic_uuid: str = ""             # Characteristic UUID
    response_data: Optional[bytearray] = None # èª­ã¿å–ã‚Šãƒ‡ãƒ¼ã‚¿
```

### WriteRequest

```python
@dataclass
class WriteRequest(BLERequest):
    service_uuid: str = ""                    # Service UUID
    characteristic_uuid: str = ""             # Characteristic UUID
    data: bytes = bytes()                     # æ›¸ãè¾¼ã¿ãƒ‡ãƒ¼ã‚¿
    response_required: bool = False           # ãƒ¬ã‚¹ãƒãƒ³ã‚¹è¦æ±‚
    response_data: Optional[bytearray] = None # ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒ‡ãƒ¼ã‚¿
```

### NotificationRequest

```python
@dataclass
class NotificationRequest(BLERequest):
    service_uuid: str = ""                    # Service UUID
    characteristic_uuid: str = ""             # Characteristic UUID
    callback_id: str = ""                     # ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ID
    notification_timeout_sec: float = 0.0     # ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼ˆ0=ç„¡é™ï¼‰
    unsubscribe: bool = False                 # è§£é™¤ãƒ•ãƒ©ã‚°
```

---

## é€šä¿¡ãƒ—ãƒ­ãƒˆã‚³ãƒ«

### ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ

**å½¢å¼**: JSONï¼ˆ1è¡Œ1ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼‰

**æ”¹è¡Œã‚³ãƒ¼ãƒ‰**: `\n` (LF)

**ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°**: UTF-8

### ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ§‹é€ 

```json
{
  "command": "ã‚³ãƒãƒ³ãƒ‰å",
  "request_id": "UUID",
  "...": "ã‚³ãƒãƒ³ãƒ‰å›ºæœ‰ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿"
}
```

### ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ§‹é€ 

**æˆåŠŸæ™‚**:
```json
{
  "status": "success",
  "request_id": "UUID",
  "result": {...}
}
```

**å¤±æ•—æ™‚**:
```json
{
  "status": "error",
  "request_id": "UUID",
  "error": "ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸"
}
```

### ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰

| ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ | åŸå›  |
|----------------|------|
| "Device not found" | ãƒ‡ãƒã‚¤ã‚¹ãŒè¦‹ã¤ã‹ã‚‰ãªã„ |
| "Connection timeout" | æ¥ç¶šã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ |
| "Request timed out" | ãƒªã‚¯ã‚¨ã‚¹ãƒˆå‡¦ç†ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ |
| "Request skipped due to age" | å¤ã„ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒã‚¹ã‚­ãƒƒãƒ—ã•ã‚ŒãŸ |
| "Unknown request type" | ä¸æ˜ãªãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚¿ã‚¤ãƒ— |
| "Invalid command" | ç„¡åŠ¹ãªã‚³ãƒãƒ³ãƒ‰ |

---

## è¨­å®šé …ç›®

**ãƒ•ã‚¡ã‚¤ãƒ«**: `ble_orchestrator/orchestrator/config.py`

### BLEè¨­å®š

| è¨­å®šé …ç›® | ç’°å¢ƒå¤‰æ•° | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ | èª¬æ˜ |
|---------|---------|-----------|------|
| `SCAN_INTERVAL_SEC` | - | 0.5 | ã‚¹ã‚­ãƒ£ãƒ³é–“éš”ï¼ˆç§’ï¼‰ |
| `SCAN_CACHE_TTL_SEC` | - | 300.0 | ã‚­ãƒ£ãƒƒã‚·ãƒ¥TTLï¼ˆç§’ï¼‰ |
| `BLE_CONNECT_TIMEOUT_SEC` | - | 10.0 | æ¥ç¶šã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ |
| `BLE_RETRY_COUNT` | - | 2 | ãƒªãƒˆãƒ©ã‚¤å›æ•° |
| `BLE_RETRY_INTERVAL_SEC` | - | 1.0 | ãƒªãƒˆãƒ©ã‚¤é–“éš” |
| `DEFAULT_SCAN_ADAPTER` | - | "hci0" | ã‚¹ã‚­ãƒ£ãƒ³ç”¨ã‚¢ãƒ€ãƒ—ã‚¿ |
| `DEFAULT_CONNECT_ADAPTER` | - | "hci1" | æ¥ç¶šç”¨ã‚¢ãƒ€ãƒ—ã‚¿ |

### ãƒ­ã‚°è¨­å®š

| è¨­å®šé …ç›® | ç’°å¢ƒå¤‰æ•° | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ | èª¬æ˜ |
|---------|---------|-----------|------|
| `LOG_DIR` | `BLE_ORCHESTRATOR_LOG_DIR` | `logs/` ã¾ãŸã¯ `/var/log/ble-orchestrator/` | ãƒ­ã‚°ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª |
| `LOG_LEVEL` | `BLE_ORCHESTRATOR_LOG_LEVEL` | "INFO" | ãƒ­ã‚°ãƒ¬ãƒ™ãƒ« |
| `LOG_TO_FILE` | `BLE_ORCHESTRATOR_LOG_TO_FILE` | "1" | ãƒ•ã‚¡ã‚¤ãƒ«å‡ºåŠ› |
| `LOG_MAX_BYTES` | `BLE_ORCHESTRATOR_LOG_MAX_BYTES` | 10485760 (10MB) | ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºä¸Šé™ |
| `LOG_BACKUP_COUNT` | `BLE_ORCHESTRATOR_LOG_BACKUP_COUNT` | 5 | ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä¸–ä»£æ•° |

### IPCè¨­å®š

| è¨­å®šé …ç›® | ç’°å¢ƒå¤‰æ•° | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ | èª¬æ˜ |
|---------|---------|-----------|------|
| `IPC_SOCKET_PATH` | `BLE_ORCHESTRATOR_SOCKET` | "/tmp/ble-orchestrator.sock" | Unixã‚½ã‚±ãƒƒãƒˆãƒ‘ã‚¹ |
| `IPC_LISTEN_HOST` | `BLE_ORCHESTRATOR_HOST` | "127.0.0.1" | TCPãƒ›ã‚¹ãƒˆ |
| `IPC_LISTEN_PORT` | `BLE_ORCHESTRATOR_PORT` | 8378 | TCPãƒãƒ¼ãƒˆ |
| `IPC_MAX_CONNECTIONS` | - | 10 | æœ€å¤§æ¥ç¶šæ•° |

### ã‚­ãƒ¥ãƒ¼è¨­å®š

| è¨­å®šé …ç›® | ç’°å¢ƒå¤‰æ•° | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ | èª¬æ˜ |
|---------|---------|-----------|------|
| `REQUEST_MAX_AGE_SEC` | - | 30.0 | ãƒªã‚¯ã‚¨ã‚¹ãƒˆæœ€å¤§å¾…æ©Ÿæ™‚é–“ |
| `SKIP_OLD_REQUESTS` | - | True | å¤ã„ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚¹ã‚­ãƒƒãƒ— |
| `SCAN_COMMAND_PARALLEL_WORKERS` | - | 3 | scan_commandãƒ¯ãƒ¼ã‚«ãƒ¼æ•° |
| `SCAN_COMMAND_TIMEOUT_SEC` | - | 5.0 | scan_commandã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ |

### æ’ä»–åˆ¶å¾¡è¨­å®š

| è¨­å®šé …ç›® | ç’°å¢ƒå¤‰æ•° | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ | èª¬æ˜ |
|---------|---------|-----------|------|
| `EXCLUSIVE_CONTROL_ENABLED` | - | True | æ’ä»–åˆ¶å¾¡æœ‰åŠ¹/ç„¡åŠ¹ |
| `EXCLUSIVE_CONTROL_TIMEOUT_SEC` | - | 30.0 | æ’ä»–åˆ¶å¾¡ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ |

### ã‚¦ã‚©ãƒƒãƒãƒ‰ãƒƒã‚°è¨­å®š

| è¨­å®šé …ç›® | ç’°å¢ƒå¤‰æ•° | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ | èª¬æ˜ |
|---------|---------|-----------|------|
| `WATCHDOG_CHECK_INTERVAL_SEC` | - | 30.0 | ãƒã‚§ãƒƒã‚¯é–“éš” |
| `CONSECUTIVE_FAILURES_THRESHOLD` | - | 3 | é€£ç¶šå¤±æ•—ã—ãã„å€¤ |

---

## ã‚¨ãƒ©ãƒ¼å‡¦ç†

### ã‚¨ãƒ©ãƒ¼ã®ç¨®é¡

#### 1. æ¥ç¶šã‚¨ãƒ©ãƒ¼

**åŸå› **:
- ãƒ‡ãƒã‚¤ã‚¹ãŒç¯„å›²å¤–
- ãƒ‡ãƒã‚¤ã‚¹ã®é›»æºã‚ªãƒ•
- Bluetoothã‚¢ãƒ€ãƒ—ã‚¿ã®å•é¡Œ

**å‡¦ç†**:
1. è‡ªå‹•ãƒªãƒˆãƒ©ã‚¤ï¼ˆ2å›ï¼‰
2. ãƒªãƒˆãƒ©ã‚¤å¤±æ•—å¾Œã€ã‚¦ã‚©ãƒƒãƒãƒ‰ãƒƒã‚°ã«é€šçŸ¥
3. ã‚¢ãƒ€ãƒ—ã‚¿ãƒªã‚»ãƒƒãƒˆ

**ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¸ã®é€šçŸ¥**:
```json
{
  "status": "error",
  "error": "Failed to connect after 2 attempts: ..."
}
```

#### 2. ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚¨ãƒ©ãƒ¼

**åŸå› **:
- ãƒªã‚¯ã‚¨ã‚¹ãƒˆå‡¦ç†æ™‚é–“è¶…é
- ã‚­ãƒ¥ãƒ¼å¾…æ©Ÿæ™‚é–“è¶…é

**å‡¦ç†**:
- ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’FAILEDã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã«æ›´æ–°
- ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹

**ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¸ã®é€šçŸ¥**:
```json
{
  "status": "error",
  "error": "Request timed out after 10.0 seconds"
}
```

#### 3. ãƒ‡ãƒã‚¤ã‚¹æœªç™ºè¦‹ã‚¨ãƒ©ãƒ¼

**åŸå› **:
- ãƒ‡ãƒã‚¤ã‚¹ãŒã‚¹ã‚­ãƒ£ãƒ³ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«å­˜åœ¨ã—ãªã„
- ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®æœ‰åŠ¹æœŸé™åˆ‡ã‚Œ

**å‡¦ç†**:
- ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹è¿”å´
- ã‚¹ã‚­ãƒ£ãƒ³ã¯ç¶™ç¶šï¼ˆè‡ªå‹•çš„ã«ç™ºè¦‹ã•ã‚Œã‚‹ï¼‰

**ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¸ã®é€šçŸ¥**:
```json
{
  "status": "error",
  "error": "Device AA:BB:CC:DD:EE:FF not found or scan data expired"
}
```

### ãƒªã‚«ãƒãƒªãƒ¼ã‚·ãƒ¼ã‚±ãƒ³ã‚¹

#### ãƒ¬ãƒ™ãƒ«1: ãƒªãƒˆãƒ©ã‚¤ï¼ˆè‡ªå‹•ï¼‰

```
æ¥ç¶šå¤±æ•— â†’ 1ç§’å¾…æ©Ÿ â†’ å†è©¦è¡Œ â†’ æˆåŠŸ/å¤±æ•—
```

#### ãƒ¬ãƒ™ãƒ«2: ã‚¢ãƒ€ãƒ—ã‚¿ãƒªã‚»ãƒƒãƒˆï¼ˆè‡ªå‹•ï¼‰

```
é€£ç¶šå¤±æ•—3å› â†’ hciconfig reset â†’ 5ç§’å¾…æ©Ÿ â†’ å†é–‹
```

#### ãƒ¬ãƒ™ãƒ«3: ã‚µãƒ¼ãƒ“ã‚¹å†èµ·å‹•ï¼ˆè‡ªå‹•ï¼‰

```
ãƒªã‚»ãƒƒãƒˆå¤±æ•— â†’ systemctl restart bluetooth â†’ 10ç§’å¾…æ©Ÿ â†’ å†é–‹
```

---

## æ’ä»–åˆ¶å¾¡ãƒ¡ã‚«ãƒ‹ã‚ºãƒ 

### ç›®çš„

BLEã‚¹ã‚­ãƒ£ãƒŠãƒ¼ã¨ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆæ¥ç¶šã‚’åŒæ™‚å®Ÿè¡Œã™ã‚‹ã¨ã€BlueZãƒ¬ãƒ™ãƒ«ã§ãƒªã‚½ãƒ¼ã‚¹ç«¶åˆãŒç™ºç”Ÿã™ã‚‹å•é¡Œã‚’å›é¿ã€‚

### å‹•ä½œã‚·ãƒ¼ã‚±ãƒ³ã‚¹

#### ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆæ¥ç¶šæ™‚

```
1. Client: read_command / send_command è¦æ±‚
2. Handler: scanner.request_scanner_stop() å‘¼ã³å‡ºã—
3. Scanner: ã‚¹ã‚­ãƒ£ãƒ³ã‚’åœæ­¢
4. Scanner: scan_completed ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¨­å®š
5. Handler: BleakClient ã§æ¥ç¶šãƒ»å‡¦ç†
6. Handler: scanner.notify_client_completed() å‘¼ã³å‡ºã—
7. Scanner: ã‚¹ã‚­ãƒ£ãƒ³ã‚’å†é–‹
8. Scanner: scan_ready ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¨­å®š
```

#### ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ

- ã‚¹ã‚­ãƒ£ãƒ³åœæ­¢å¾…æ©Ÿ: 10ç§’
- ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå‡¦ç†: ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®šæ¬¡ç¬¬
- ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå®Œäº†å¾…æ©Ÿ: 60ç§’

#### ãƒ‡ãƒƒãƒ‰ãƒ­ãƒƒã‚¯æ¤œå‡º

- æ’ä»–åˆ¶å¾¡ãŒ90ç§’ä»¥ä¸Šç¶™ç¶šã—ãŸå ´åˆã€ãƒ‡ãƒƒãƒ‰ãƒ­ãƒƒã‚¯ã¨åˆ¤å®š
- å¼·åˆ¶çš„ã«æ’ä»–åˆ¶å¾¡ã‚’ãƒªã‚»ãƒƒãƒˆï¼ˆè­¦å‘Šãƒ­ã‚°å‡ºåŠ›ï¼‰

### ç„¡åŠ¹åŒ–

æ’ä»–åˆ¶å¾¡ã¯ç’°å¢ƒå¤‰æ•°ã¾ãŸã¯è¨­å®šã§ç„¡åŠ¹åŒ–å¯èƒ½ï¼š

```python
EXCLUSIVE_CONTROL_ENABLED = False
```

---

## ãƒ­ã‚°ä»•æ§˜

### ãƒ­ã‚°ãƒ¬ãƒ™ãƒ«

| ãƒ¬ãƒ™ãƒ« | ç”¨é€” |
|-------|------|
| DEBUG | è©³ç´°ãªãƒ‡ãƒãƒƒã‚°æƒ…å ± |
| INFO | é€šå¸¸ã®å‹•ä½œæƒ…å ± |
| WARNING | è­¦å‘Šï¼ˆå‡¦ç†ã¯ç¶™ç¶šï¼‰ |
| ERROR | ã‚¨ãƒ©ãƒ¼ï¼ˆå‡¦ç†å¤±æ•—ï¼‰ |

### ãƒ­ã‚°ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³

- **æ–¹å¼**: `RotatingFileHandler`
- **ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºä¸Šé™**: 10MBï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰
- **ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä¸–ä»£æ•°**: 5ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰
- **åˆè¨ˆæœ€å¤§ã‚µã‚¤ã‚º**: ç´„60MB

### ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«

- **ç¾åœ¨ã®ãƒ­ã‚°**: `ble_orchestrator.log`
- **ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—**: `ble_orchestrator.log.1` ã€œ `.5`

### ä¸»è¦ãƒ­ã‚°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸

| ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ | ãƒ¬ãƒ™ãƒ« | æ„å‘³ |
|----------|-------|------|
| "BLE Orchestrator service initialized" | INFO | ã‚µãƒ¼ãƒ“ã‚¹åˆæœŸåŒ–å®Œäº† |
| "All components started successfully" | INFO | å…¨ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆèµ·å‹•å®Œäº† |
| "Enqueued request XXX" | INFO | ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒã‚­ãƒ¥ãƒ¼ã«è¿½åŠ  |
| "Processing request XXX" | DEBUG | ãƒªã‚¯ã‚¨ã‚¹ãƒˆå‡¦ç†é–‹å§‹ |
| "Request XXX completed successfully" | INFO | ãƒªã‚¯ã‚¨ã‚¹ãƒˆå‡¦ç†å®Œäº† |
| "Failed to connect after N attempts" | WARNING | æ¥ç¶šå¤±æ•— |
| "Recreation needed: No devices detected" | WARNING | ã‚¹ã‚­ãƒ£ãƒŠãƒ¼å†ä½œæˆå¿…è¦ |
| "Scanner stopped for client connection" | INFO | æ’ä»–åˆ¶å¾¡ã§ã‚¹ã‚­ãƒ£ãƒ³åœæ­¢ |
| "POTENTIAL DEADLOCK DETECTED" | ERROR | ãƒ‡ãƒƒãƒ‰ãƒ­ãƒƒã‚¯æ¤œå‡º |

---

## ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç‰¹æ€§

### ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·

| æ“ä½œ | æ¨™æº– | æœ€å¤§ |
|-----|------|------|
| scan_command | <10ms | 100ms |
| read_command | 100-500ms | 10ç§’ |
| send_command | 100-500ms | 10ç§’ |
| subscribe_notifications | 1-3ç§’ | 10ç§’ |

### ã‚¹ãƒ«ãƒ¼ãƒ—ãƒƒãƒˆ

- **scan_command**: ä¸¦è¡Œ3ãƒªã‚¯ã‚¨ã‚¹ãƒˆ/ç§’ä»¥ä¸Š
- **read/send_command**: é€æ¬¡å‡¦ç†ã€1ãƒªã‚¯ã‚¨ã‚¹ãƒˆ/ç§’ç¨‹åº¦
- **é€šçŸ¥**: ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ï¼ˆé…å»¶<100msï¼‰

### ãƒªã‚½ãƒ¼ã‚¹ä½¿ç”¨é‡

| ãƒªã‚½ãƒ¼ã‚¹ | é€šå¸¸æ™‚ | ãƒ”ãƒ¼ã‚¯æ™‚ |
|---------|-------|---------|
| CPU | 1-3% | 10% |
| ãƒ¡ãƒ¢ãƒª | 30-50MB | 100MB |
| ãƒ‡ã‚£ã‚¹ã‚¯ï¼ˆãƒ­ã‚°ï¼‰ | 60MB | 100MB |

---

## ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è€ƒæ…®äº‹é …

### ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡

- **Unixã‚½ã‚±ãƒƒãƒˆ**: ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ãƒ¼ãƒŸãƒƒã‚·ãƒ§ãƒ³ï¼ˆ0666ï¼‰
- **TCPã‚½ã‚±ãƒƒãƒˆ**: localhostã®ã¿ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰
- **èªè¨¼**: ãªã—ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«é€šä¿¡ã®ã¿ã‚’æƒ³å®šï¼‰

### ãƒ‡ãƒ¼ã‚¿ä¿è­·

- **ãƒ­ã‚°**: MACã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å«ã‚€ï¼ˆæ©Ÿå¯†æ€§æ³¨æ„ï¼‰
- **IPCé€šä¿¡**: æš—å·åŒ–ãªã—ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«é€šä¿¡ã®ã¿ï¼‰

### æ¨å¥¨äº‹é …

1. æœ¬ç•ªç’°å¢ƒã§ã¯ãƒ•ã‚¡ã‚¤ã‚¢ã‚¦ã‚©ãƒ¼ãƒ«è¨­å®š
2. ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ãƒ¼ãƒŸãƒƒã‚·ãƒ§ãƒ³åˆ¶é™
3. Unixã‚½ã‚±ãƒƒãƒˆã®ä½¿ç”¨ï¼ˆTCPã‚ˆã‚Šå®‰å…¨ï¼‰

---

## åˆ¶é™äº‹é …

### ã‚·ã‚¹ãƒ†ãƒ è¦ä»¶

- **OS**: Linuxï¼ˆBlueZå¿…é ˆï¼‰
- **Python**: 3.9ä»¥ä¸Š
- **æ¨©é™**: Bluetoothæ“ä½œã«ã¯rootæ¨©é™ã¾ãŸã¯cap_net_admin

### BLEä»•æ§˜

- **åŒæ™‚æ¥ç¶šãƒ‡ãƒã‚¤ã‚¹æ•°**: ãƒãƒ¼ãƒ‰ã‚¦ã‚§ã‚¢ä¾å­˜ï¼ˆé€šå¸¸1-7å°ï¼‰
- **ã‚¹ã‚­ãƒ£ãƒ³å¯¾è±¡**: BLE 4.0ä»¥ä¸Šã®ãƒ‡ãƒã‚¤ã‚¹
- **é€šä¿¡è·é›¢**: ç´„10-30mï¼ˆç’°å¢ƒä¾å­˜ï¼‰

### æ—¢çŸ¥ã®å•é¡Œ

1. **è¤‡æ•°ã‚¢ãƒ€ãƒ—ã‚¿ä½¿ç”¨æ™‚ã®ç«¶åˆ**
   - æ’ä»–åˆ¶å¾¡ã§å›é¿å¯èƒ½
   - æ¨å¥¨: ã‚¹ã‚­ãƒ£ãƒ³ç”¨ã¨ãƒ¡ã‚¤ãƒ³æ¥ç¶šç”¨ã§åˆ†é›¢

2. **é•·æ™‚é–“æ¥ç¶šã®å®‰å®šæ€§**
   - Notificationè³¼èª­ã¯å®‰å®š
   - é€šå¸¸ã®æ¥ç¶šã¯çŸ­æ™‚é–“æ¨å¥¨

3. **å¤§é‡ãƒ‡ãƒã‚¤ã‚¹ã®ã‚¹ã‚­ãƒ£ãƒ³**
   - ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒå¤§ãããªã‚‹
   - TTLã§è‡ªå‹•å‰Šé™¤

---

## ä»Šå¾Œã®æ‹¡å¼µäºˆå®š

1. **èªè¨¼æ©Ÿèƒ½**: ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆèªè¨¼
2. **ãƒ¡ãƒˆãƒªã‚¯ã‚¹**: Prometheuså¯¾å¿œ
3. **Web UI**: ç®¡ç†ç”»é¢
4. **ãƒãƒ«ãƒã‚¢ãƒ€ãƒ—ã‚¿**: è² è·åˆ†æ•£

---

**ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãƒãƒ¼ã‚¸ãƒ§ãƒ³**: 1.0  
**æœ€çµ‚æ›´æ–°**: 2025-10-24

